<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Greater Manchester Rail Dashboard</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{
      --bg: #0b0f14;
      --border: rgba(255,255,255,.10);
      --text: #e6edf3;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .app{ height:100vh; display:grid; grid-template-rows: 64px 1fr; }

    header{
      display:flex; align-items:center; gap:14px;
      padding: 10px 14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,26,40,.95), rgba(11,15,20,.95));
      backdrop-filter: blur(6px);
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width: 320px; }
    .logo{
      width:44px; height:44px; border-radius: 12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; padding:6px; }
    .brand-title{ display:flex; flex-direction:column; line-height:1.1; }
    .brand-title .h1{ font-weight:650; letter-spacing:.2px; font-size:16px; }
    .brand-title .sub{ color:var(--muted); font-size:12px; margin-top:3px; }

    .header-right{ margin-left:auto; display:flex; align-items:center; gap:10px; }
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }

    main{ display:grid; grid-template-columns: 420px 1fr; min-height:0; }

    .sidebar{
      border-right:1px solid var(--border);
      background: radial-gradient(1200px 500px at 0% 0%, rgba(56,189,248,.10), transparent 40%),
                  linear-gradient(180deg, rgba(16,26,40,.8), rgba(11,15,20,.9));
      padding: 12px;
      overflow:auto;
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:22px; font-weight:700; margin-top:2px; }

    .search{ margin: 10px 0; display:flex; gap:8px; }
    input[type="search"]{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    input[type="search"]::placeholder{ color: rgba(148,163,184,.8); }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }

    .section-title{
      margin: 10px 0 8px;
      font-weight:700;
      font-size:13px;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .section-title .count{ color:var(--muted); font-weight:600; font-size:12px; }

    .list{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }
    .row{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      cursor:pointer;
    }
    .row:hover{
      border-color: rgba(56,189,248,.35);
      background: rgba(56,189,248,.08);
    }
    .row .name{ font-weight:650; font-size:13px; }
    .row .meta{
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row .meta a{ color: var(--accent); text-decoration: none; }
    .row .meta a:hover{ text-decoration: underline; }
    .row .desc{ color:var(--muted); font-size:12px; line-height:1.35; }

    #map{ height:100%; width:100%; }

    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      background: #101826;
      color: #e6edf3;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .leaflet-popup-content a { color: #7dd3fc; text-decoration:none; }
    .leaflet-popup-content a:hover { text-decoration:underline; }
    .leaflet-control-attribution{
      background: rgba(16,24,38,0.85) !important;
      color:#cbd5e1 !important;
    }
    .leaflet-control-attribution a{ color:#93c5fd !important; }

    .pop-h{ color:#94a3b8; font-weight:700; margin-top:10px; }
    .pop-p{ margin-top:4px; color:#cbd5e1; font-size:12px; line-height:1.35; }
    .pop-links{ margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" title="Add your logo file to /assets and update the src below">
          <img src="./assets/bee-network-rail.svg" alt="Bee Network Rail">
        </div>
        <div class="brand-title">
          <div class="h1">Greater Manchester Rail</div>
          <div class="sub">Stations map • NRE + Realtime Trains • Wikipedia summaries</div>
        </div>
      </div>

      <div class="header-right">
        <div class="pill"><span class="dot"></span> Static map</div>
        <div class="pill" id="buildStamp">Build: —</div>
      </div>
    </header>

    <main>
      <aside class="sidebar">
        <div class="kpis">
          <div class="card kpi">
            <div class="label">Stations loaded</div>
            <div class="value" id="kpiStations">0</div>
          </div>
          <div class="card kpi">
            <div class="label">Showing</div>
            <div class="value" id="kpiShowing">0</div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <span>Find a station</span>
            <span class="count" id="resultCount">—</span>
          </div>

          <div class="search">
            <input id="q" type="search" placeholder="Search station name…" autocomplete="off">
            <button class="btn" id="clearBtn" title="Clear">Clear</button>
          </div>

          <div class="section-title">
            <span>Stations</span>
            <span class="count" id="listCount">—</span>
          </div>

          <div class="list" id="list"></div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="section-title"><span>Selected</span></div>
          <div id="selected" style="color:var(--muted); font-size:12px;">Click a marker or a station in the list.</div>
          <div style="color:var(--muted); font-size:12px; margin-top:8px;">
            Tip: Wikipedia summaries load when you open a popup (cached afterwards).
          </div>
        </div>
      </aside>

      <div id="map"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.getElementById("buildStamp").textContent =
      "Build: " + new Date().toISOString().slice(0,10);

    const map = L.map("map", { zoomControl: true }).setView([53.48, -2.24], 10);

    // Dark basemap
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      subdomains: "abcd",
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    let allFeatures = [];
    let markerLayer = null;
    const markerById = new Map();

    function featureId(f, idx){
      return (f.id || f.properties?.["@id"] || f.properties?.id || ("idx:" + idx));
    }

    function getCrs(props){
      // CRS fix: supports both "crs" and OSM-style "ref:crs"
      return String(props?.crs ?? props?.["ref:crs"] ?? "").toUpperCase();
    }

    function getWikidataQid(props){
      // Common tags: wikidata / network:wikidata
      const q = String(props?.wikidata ?? props?.["network:wikidata"] ?? "").trim();
      return /^Q\d+$/i.test(q) ? q.toUpperCase() : "";
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function routesDescription(props){
      const d = String(props?.description ?? "").trim();
      if (!d) return null;
      return d.length > 240 ? (d.slice(0, 240) + "…") : d;
    }

    // National Rail Enquiries station page (deep link if present in OSM export)
    function nreLink(props){
      const direct = props?.["network:website"];
      if (direct && /^https:\/\/www\.nationalrail\.co\.uk\/stations\//i.test(direct)) return direct;
      return "https://www.nationalrail.co.uk/stations/";
    }

    // RealtimeTrains link (external)
    function rttLink(props){
      const crs = getCrs(props);
      if (crs) return `https://www.realtimetrains.co.uk/search/detailed/${encodeURIComponent(crs)}`;
      return nreLink(props);
    }

    /***********************
     * Wikipedia summary cache
     * - loads on popup open
     * - cached in memory + localStorage
     ***********************/
    const wikiMemCache = new Map(); // qid -> { ts, title, extract, url }
    const WIKI_TTL_MS = 1000 * 60 * 60 * 24 * 30; // 30 days

    function loadStoredWiki(qid){
      try{
        const raw = localStorage.getItem("wikiSummary:" + qid);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ts) return null;
        if (Date.now() - obj.ts > WIKI_TTL_MS) return null;
        return obj;
      } catch {
        return null;
      }
    }

    function storeWiki(qid, obj){
      try{
        localStorage.setItem("wikiSummary:" + qid, JSON.stringify(obj));
      } catch {
        // ignore quota errors
      }
    }

    async function fetchWikipediaSummaryFromWikidata(qid){
      // 1) Get the enwiki title (sitelink) from Wikidata entity JSON
      const wdUrl = `https://www.wikidata.org/wiki/Special:EntityData/${encodeURIComponent(qid)}.json`;
      const wdRes = await fetch(wdUrl, { headers: { "Accept": "application/json" } });
      if (!wdRes.ok) throw new Error("Wikidata fetch failed");
      const wd = await wdRes.json();

      const ent = wd?.entities?.[qid];
      const enwikiTitle = ent?.sitelinks?.enwiki?.title;

      if (!enwikiTitle) {
        // fall back: no enwiki sitelink
        return { title: "", extract: "", url: "" };
      }

      // 2) Fetch Wikipedia REST summary
      const wpUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(enwikiTitle)}`;
      const wpRes = await fetch(wpUrl, { headers: { "Accept": "application/json" } });
      if (!wpRes.ok) throw new Error("Wikipedia summary fetch failed");
      const wp = await wpRes.json();

      const extract = String(wp?.extract ?? "").trim();
      const title = String(wp?.title ?? enwikiTitle);
      const url = String(wp?.content_urls?.desktop?.page ?? "");

      return { title, extract, url };
    }

    async function getWikiSummary(qid){
      if (!qid) return null;

      if (wikiMemCache.has(qid)) {
        const obj = wikiMemCache.get(qid);
        if (Date.now() - obj.ts <= WIKI_TTL_MS) return obj;
      }

      const stored = loadStoredWiki(qid);
      if (stored) {
        wikiMemCache.set(qid, stored);
        return stored;
      }

      const { title, extract, url } = await fetchWikipediaSummaryFromWikidata(qid);
      const obj = { ts: Date.now(), title, extract, url };

      wikiMemCache.set(qid, obj);
      storeWiki(qid, obj);
      return obj;
    }

    function truncate(s, n){
      const t = String(s || "").trim();
      if (!t) return "";
      return t.length > n ? (t.slice(0, n) + "…") : t;
    }

    function popupHtml(name, crs, props, stationKey){
      const desc = routesDescription(props);
      const qid = getWikidataQid(props);
      const nre = nreLink(props);
      const rtt = rttLink(props);

      // If no OSM description, we show a placeholder that will be replaced on popupopen
      const aboutBlock = desc
        ? `
          <div class="pop-h">Routes served</div>
          <div class="pop-p">${escapeHtml(desc)}</div>
        `
        : `
          <div class="pop-h">About this station</div>
          <div class="pop-p">
            <span class="wiki-summary" data-qid="${escapeHtml(qid)}" data-key="${escapeHtml(stationKey)}">
              ${qid ? "Loading Wikipedia summary…" : "No Wikidata tag found for this station."}
            </span>
          </div>
        `;

      return `
        <div style="min-width:260px">
          <div style="font-weight:700; font-size:14px;">${escapeHtml(name)}</div>
          ${crs ? `<div style="color:#94a3b8; margin-top:2px;">CRS: ${escapeHtml(crs)}</div>` : ``}
          ${aboutBlock}
          <div class="pop-links">
            <a href="${nre}" target="_blank" rel="noopener">National Rail Enquiries</a>
            <a href="${rtt}" target="_blank" rel="noopener">Realtime Trains</a>
          </div>
        </div>
      `;
    }

    async function hydratePopupWithWiki(layer){
      // Called when popup opens; finds the placeholder and swaps it for the cached/loaded summary
      const popup = layer.getPopup();
      const el = popup?.getElement();
      if (!el) return;

      const span = el.querySelector(".wiki-summary");
      if (!span) return;

      const qid = span.getAttribute("data-qid") || "";
      if (!qid) return;

      try{
        const summary = await getWikiSummary(qid);
        if (!summary) return;

        const extract = truncate(summary.extract, 260);
        if (!extract) {
          span.textContent = "No Wikipedia summary available.";
          return;
        }

        const link = summary.url ? ` <a href="${summary.url}" target="_blank" rel="noopener">(Wikipedia)</a>` : "";
        span.innerHTML = `${escapeHtml(extract)}${link}`;
      } catch {
        span.textContent = "Couldn’t load Wikipedia summary right now.";
      }
    }

    function renderMarkers(features){
      if (markerLayer) markerLayer.remove();

      markerLayer = L.geoJSON({ type:"FeatureCollection", features }, {
        pointToLayer: (f, latlng) =>
          L.circleMarker(latlng, {
            radius: 6,
            weight: 2,
            color: "#93c5fd",
            fillColor: "#38bdf8",
            fillOpacity: 0.9
          }),

        onEachFeature: (f, l) => {
          const name = f.properties?.name ?? "Station";
          const crs  = getCrs(f.properties);
          const id   = featureId(f, 0);

          l.bindPopup(popupHtml(name, crs, f.properties, id));

          l.on("click", () => {
            document.getElementById("selected").textContent = crs ? `${name} (${crs})` : name;
          });

          l.on("popupopen", async () => {
            await hydratePopupWithWiki(l);
          });
        }
      }).addTo(map);

      markerById.clear();
      let idx = 0;
      markerLayer.eachLayer(layer => {
        const f = layer.feature;
        const id = featureId(f, idx++);
        markerById.set(id, layer);
      });

      return markerLayer;
    }

    function renderList(features){
      const list = document.getElementById("list");
      list.innerHTML = "";

      const sorted = [...features].sort((a,b) => {
        const an = (a.properties?.name || "").toLowerCase();
        const bn = (b.properties?.name || "").toLowerCase();
        return an.localeCompare(bn);
      });

      sorted.forEach((f, idx) => {
        const id = featureId(f, idx);
        const name = f.properties?.name ?? "Station";
        const crs  = getCrs(f.properties);

        const nre = nreLink(f.properties);
        const rtt = rttLink(f.properties);

        // For the list, show OSM description if present; otherwise nothing (to avoid hammering)
        const desc = routesDescription(f.properties);

        const el = document.createElement("div");
        el.className = "row";
        el.innerHTML = `
          <div class="name">${escapeHtml(name)}</div>
          <div class="meta">
            <span>${crs ? "CRS: " + escapeHtml(crs) : "CRS: —"}</span>
            <span>•</span>
            <a href="${nre}" target="_blank" rel="noopener">NRE</a>
            <span>•</span>
            <a href="${rtt}" target="_blank" rel="noopener">Realtime</a>
          </div>
          ${desc ? `<div class="desc">${escapeHtml(desc)}</div>` : ``}
        `;

        el.addEventListener("click", () => {
          const layer = markerById.get(id);
          if (!layer) return;

          const ll = layer.getLatLng();
          map.setView(ll, Math.max(map.getZoom(), 13), { animate: true });
          layer.openPopup();

          document.getElementById("selected").textContent = crs ? `${name} (${crs})` : name;
        });

        list.appendChild(el);
      });

      document.getElementById("listCount").textContent = `${sorted.length} listed`;
    }

    function applyFilter(){
      const q = document.getElementById("q").value.trim().toLowerCase();
      const filtered = !q ? allFeatures : allFeatures.filter(f => {
        const name = (f.properties?.name || "").toLowerCase();
        return name.includes(q);
      });

      document.getElementById("kpiShowing").textContent = String(filtered.length);
      document.getElementById("resultCount").textContent = q ? `Matches: ${filtered.length}` : `All: ${filtered.length}`;

      renderMarkers(filtered);
      renderList(filtered);

      if (!q && markerLayer && markerLayer.getBounds().isValid()){
        map.fitBounds(markerLayer.getBounds(), { padding: [20,20] });
      }
    }

    async function loadStations(){
      const res = await fetch("./data/stations.geojson");
      if (!res.ok) throw new Error(`Failed to load stations.geojson (${res.status})`);
      const gj = await res.json();

      allFeatures = (gj.features || []).filter(f => f.geometry && f.geometry.type === "Point");
      document.getElementById("kpiStations").textContent = String(allFeatures.length);

      renderMarkers(allFeatures);
      renderList(allFeatures);
      document.getElementById("kpiShowing").textContent = String(allFeatures.length);
      document.getElementById("resultCount").textContent = `All: ${allFeatures.length}`;

      if (markerLayer && markerLayer.getBounds().isValid()){
        map.fitBounds(markerLayer.getBounds(), { padding: [20,20] });
      }
    }

    document.getElementById("q").addEventListener("input", applyFilter);
    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("q").value = "";
      applyFilter();
    });

    loadStations().catch(err => alert(err.message));
  </script>
</body>
</html>